<div class="signup-box-header">
	<div class="signup-state">
	    <h3>商家入驻流程</h3>
	    <ul class="signup-flow-list">
	    	<li class="on arrow-icon"><{t}>公司基本信息<{/t}><span class="arrow"></span></li>
	        <li class="arrow-icon"><{t}>提交完成，等待审核<{/t}></li>
	        <li><{t}>审核通过，等待签约<{/t}></li>
	    </ul>
	</div>
</div><div class="signup-box signup-wrap rci-page-box">
	<form action="" method="post" class="form-horizontal" role="form" data-validate-onsuccess="ajaxSubmit">
	    <input type="hidden" name="enterapply_id" value="<{$applydata.enterapply_id}>">
	    <!-- <fieldset> -->
	      <div class="panel panel-outter">
	        <div class="panel-body">
		        <div class="col-md-12">
		            <div>
					  <legend id="license">填写公司基本信息</legend>
		              <{$applydata.company_addr}>
		            </div>
		            <div class="form-group">
		              <label for="company_name" class="control-label col-md-3"><span class="text-red">*</span>公司名称：</label>
		              <div class="col-md-5 relative">
		                <input type="text" name="company_name" value="<{$applydata.company_name}>" id="company_name" class="form-control" placeholder="请输入公司名称，必须跟营业执照上一致。" maxlength="50" required>
		              </div>
					</div>
					<div class="form-group">
						<label for="representative" class="control-label col-md-3"><span class="text-red">*</span>公司法人：</label>
						<div class="col-md-5">
						  <input type="text" name="shop_info[representative]" value="<{$applydata.shop_info.representative}>" id="representative" class="form-control" placeholder="输入营业执照上公司法人姓名" required>
						</div>
					</div>
					<div class="form-group">
						<label for="license_num" class="control-label col-md-3"><span class="text-red">*</span>统一社会信用代码：</label>
						<div class="col-md-5">
						  <input type="text" name="shop_info[license_num]" value="<{$applydata.shop_info.license_num}>" id="license_num"  class="form-control"  placeholder="输入营业执照上的18位统一社会信用代码" required>
						</div>
					</div>
					<div class="form-group">
		              <label for="company_addr" class="control-label col-md-3"><span class="text-red">*</span>公司所在地址：</label>
		              <div class="col-md-5">
		                <input type="text" name="shop_info[company_addr]" value="<{$applydata.shop_info.company_addr}>" id="company_addr" class="form-control" placeholder="请与营业执照上的地址信息一致" maxlength="50" required>
		              </div>
		            </div>
					<div class="form-group">
		              <label for="shop_type" class="control-label col-md-3"><span class="text-red">*</span>店铺类型：</label>
		              <div class="col-md-5">
		                <select name="shop_type" id="shop_type" class="form-control" required>
		                  <option value="" data-suffix="">请先选择店铺类型</option>
		                  <{foreach from=$shoptypelist item=shoptype key=key}>
	                      <{if $shoptype.shop_type != 'self'}>
	                      	<option value="<{$shoptype.shop_type}>" data-suffix="<{$shoptype.suffix}>" <{if $shoptype.shop_type == $applydata.shop_type}>selected<{/if}>><{$shoptype.name}> (后缀名为<{$shoptype.suffix}>)</option>
	                      <{/if}>
		                  <{/foreach}>
		                </select>
		              </div>
		            </div>
					<div class="form-group rci-shop-cart">
		              <label for="shop_cart" class="control-label col-md-3"><span class="text-red">*</span>店铺经营类目：</label>
		              <div class="col-md-5">
		                <select name="shop[shop_cat][]" id="shop_cat" class="form-control" autocomplete="off" required>
		                  <option value="">请先选择经营类目</option>
		                  <{foreach from=$catlist item=catname key=key}>
		                  <option  value="<{$key}>"><{$catname}></option>
		                  <{/foreach}>
		                </select>
		                <div class="select-cat">
		                  <label for="">已选类目：</label>
		                  <div class="select-cat-item"></div>
		                </div>
		              </div>
		            </div>
		            <div class="form-group rci-form-group" id='license-img-form'>
					  <label for="license_img" class="control-label col-md-3"><span class="text-red">*</span>上传营业执照副本扫描件：</label>
					  <div class="col-md-5 relative">
						<span class="text-red">请上传盖好公章的营业执照扫副本扫描件，文件不能大于<{$env.config.image.uploadedFileMaxSize|format_filesize}></span>&nbsp;&nbsp;<a href="<{$resUrl}>/images/yyzz0328.jpg" class="img-example">查看示例</a>
					  </div>
		              <div class="col-md-5 relative">
		                <div class="choose-image">
		                  <input type="file" multiple  class="mul-file-input" style="display:none;" data-size="<{$env.config.image.uploadedFileMaxSize}>" name="shop_info[license_img]" data-remote="<{url action=toputil_ctl_image@uploadImages from=seller type=shop_apply}>" accept="image/png,image/jpg,image/gif,image/jpeg" required />

						  <span class="image-wrapper">
		                  <{if $applydata.shop_info.license_img}>
		                  <{foreach from=$applydata.shop_info.license_img item=license key=key}>
		                  	<span class="image-box" data-index="<{$key}>">
								<img src="<{$license|storager:t}>" />
								<input type="hidden" name="shop_info[license_img][<{$key}>]" value="<{$license}>">
								<div class="image-mask">
									<a href="<{$license|storager:t}>" class="img-detail_btn">
										<i class="fa fa-search-plus show-img"></i>
									</a>
									<i class="fa fa-trash del-img_btn"></i>
								</div>
							</span>
		                   <{/foreach}>
						  <{/if}>
						    <span class="add-img_btn rci-action-upload">+</span>
						  </span>
						  
						</div>
		              </div>
					</div>
					
		            <div class="form-group rci-form-group">
		              <label for="trademark_img" class="control-label col-md-3"><!-- <span class="text-red">*</span> -->上传商标证书扫描件：</label>
					  <div class="col-md-5 "><span class="text-red">上传商标证书扫描件不能大于<{$env.config.image.uploadedFileMaxSize|format_filesize}></span>&nbsp;&nbsp;<a href="<{$resUrl}>/images/sbzs0328.jpg" class="img-example">查看示例</a></div>
					  <div class="col-md-6 relative">
		                <div class="choose-image">
		                  <input type="file" multiple  class="mul-file-input" style="display:none;" data-size="<{$env.config.image.uploadedFileMaxSize}>" name="shop_info[trademark_img]" data-remote="<{url action=toputil_ctl_image@uploadImages from=seller type=shop_apply}>" accept="image/png,image/jpg,image/gif,image/jpeg" required/>
						 
						  <span class="image-wrapper">
							
						  <{if $applydata.shop_info.trademark_img}>
		                  <{foreach from=$applydata.shop_info.trademark_img item=trademark key=key}>
		                  	<span class="image-box" data-index="<{$key}>">
								<img src="<{$trademark|storager:t}>" />
								<input type="hidden" name="shop_info[trademark_img][<{$key}>]" value="<{$trademark}>">
								<div class="image-mask">
									<a href="<{$trademark|storager:t}>" class="img-detail_btn">
										<i class="fa fa-search-plus show-img" ></i>
									</a>
									<i class="fa fa-trash del-img_btn"></i>
								</div>
							</span>
		                   <{/foreach}>
						  <{/if}>
						  <span class="add-img_btn rci-action-upload">+</span>
						 </span>
						 
		                </div>
		                <!-- <div class="remind-content"><i class="glyphicon glyphicon-exclamation-sign"></i><span class="w45p">外国人请上传护照个人信息页</span></div> -->
		              </div>
					</div>
					
		            <div class="form-group rci-form-group">
		              <label for="inspection_report_img" class="control-label col-md-3">
		              	<!-- <span class="text-red">*</span> -->
					  上传质检报告扫描件：</label>
					  <div  class="col-md-5"><span class="text-red">上传质检报告扫描件不能大于<{$env.config.image.uploadedFileMaxSize|format_filesize}></span>&nbsp;&nbsp;<a href="<{$resUrl}>/images/zjbg1-0328.jpg" class="img-example">查看示例</a></div>
		              <div class="col-md-6">
		                <div class="choose-image">
		                  <input type="file" multiple  class="mul-file-input" style="display:none;" data-size="<{$env.config.image.uploadedFileMaxSize}>" name="shop_info[inspection_report_img]" data-remote="<{url action=toputil_ctl_image@uploadImages from=seller type=shop_apply}>" accept="image/png,image/jpg,image/gif,image/jpeg" required/>
						  <span class="image-wrapper">
						  	<{if $applydata.shop_info.inspection_report_img}>
			                  <{foreach from=$applydata.shop_info.inspection_report_img item=inspection_report key=key}>
			                  	<span class="image-box" data-index="<{$key}>">
									<img src="<{$inspection_report|storager:t}>" />
									<input type="hidden" name="shop_info[inspection_report_img][<{$key}>]" value="<{$inspection_report}>">
									<div class="image-mask"></div>
									<div class="image-mask">
										<a href="<{$inspection_report|storager:t}>" class="img-detail_btn">
											<i class="fa fa-search-plus show-img"></i>
										</a>
										<i class="fa fa-trash del-img_btn" ></i>
									</div>
								</span>
			                   <{/foreach}>
							  <{/if}>
							  <span class="add-img_btn rci-action-upload">+</span>
						  </span>
						
		                </div>
		              </div>
					</div>
					
		            <div class="form-group rci-form-group">
                  	  <label for="barcode_certificate_img" class="control-label col-md-3">
					  <!-- <span class="text-red">*</span> -->上传条码证书扫描件：</label>
					  <div class="col-md-5 "><span class="text-red">上传条码证书扫描件不能大于<{$env.config.image.uploadedFileMaxSize|format_filesize}></span>&nbsp;&nbsp;<a href="<{$resUrl}>/images/zzjgdm.jpg" class="img-example">查看示例</a></div>
		              <div class="col-md-6">
		                <div class="choose-image">
							<input type="file"  multiple  class="mul-file-input" style="display:none;" data-size="<{$env.config.image.uploadedFileMaxSize}>" name="shop_info[barcode_certificate_img]" data-remote="<{url action=toputil_ctl_image@uploadImages from=seller type=shop_apply}>" accept="image/png,image/jpg,image/gif,image/jpeg" required/>
							<span class="image-wrapper">
						  	  <{if $applydata.shop_info.barcode_certificate_img}>
			                  <{foreach from=$applydata.shop_info.barcode_certificate_img item=barcode_certificate key=key}>
			                  	<span class="image-box" data-index="<{$key}>">
									<img src="<{$barcode_certificate|storager:t}>"/>
									<input type="hidden" name="shop_info[barcode_certificate_img][<{$key}>]" value="<{$barcode_certificate}>">
									<div class="image-mask">
										<a href="<{$barcode_certificate|storager:t}>" class="img-detail_btn">
											<i class="fa fa-search-plus show-img"></i>
										</a>
										<i class="fa fa-trash del-img_btn"></i>
									</div>
								</span>
			                   <{/foreach}>
							  <{/if}>
							  <span class="add-img_btn rci-action-upload">+</span>
						  </span>
						 
		                </div>
		              </div>
					</div>
					<div>
						<legend id="bank">填写收款银行信息</legend>
					  </div>
					  <div class="form-group">
						  <label for="bank_name" class="control-label col-md-3"><span class="text-red">*</span>开户银行：</label>
						  <div class="col-md-5 relative">
							<input type="text" name="shop_info[bank_name]" value="<{$applydata.shop_info.bank_name}>" id="bank_name" class="form-control" placeholder="请输入详细的开户银行" maxlength="50" required>
							<div class="remind-content"><i class="gly"></i><span class="w62p">比如：平安银行深圳南山支行</span></div>
						  </div>
					  </div>
					  <div class="form-group">
						  <label for="bankID" class="control-label col-md-3"><span class="text-red">*</span>银行账户：</label>
						  <div class="col-md-5">
							<input type="text" name="shop_info[bankID]" value="<{$applydata.shop_info.bankID}>" id="bankID" class="form-control" placeholder="请输入开户银行的银行卡账号信息" maxlength="50" required>
						  </div>
					  </div>
  
					  <div class="form-group">
						  <label for="bankID" class="control-label col-md-3"><span class="text-red">*</span>收款人姓名：</label>
						  <div class="col-md-5">
							<input type="text" name="shop_info[bank_user_name]" value="<{$applydata.shop_info.bank_user_name}>" id="username" class="form-control" placeholder="请输入银行卡的开户人姓名" maxlength="50" required>
						  </div>
					  </div>

					  <div>
						<legend id="bank">填写退货信息</legend>
					  </div>
					  <div class="form-group">
						  <label for="bank_name" class="control-label col-md-3"><span class="text-red">*</span>退货地址：</label>
						  <div class="col-md-5 relative">
							<input type="text" name="shop_info[return_back_addr]" value="<{$applydata.shop_info.return_back_addr}>" id="return_back_addr" class="form-control" placeholder="请填写收货人地址详细到街道" maxlength="50" required>
						  </div>
					  </div>
					  <div class="form-group">
						  <label for="bankID" class="control-label col-md-3"><span class="text-red">*</span>收货人：</label>
						  <div class="col-md-5">
							<input type="text" name="shop_info[return_back_contacts]" value="<{$applydata.shop_info.return_back_contacts}>" id="return_back_contacts" class="form-control" placeholder="请填写收货人姓名" maxlength="50" required>
						  </div>
					  </div>
  
					  <div class="form-group">
						  <label for="bankID" class="control-label col-md-3"><span class="text-red">*</span>收货人电话：</label>
						  <div class="col-md-5">
							<input type="text" name="shop_info[return_back_cmobile]" value="<{$applydata.shop_info.return_back_cmobile}>" id="return_back_cmobile" class="form-control" placeholder="请填写收货人电话" pattern="^([1]\d{10}|([\(（]?0[0-9]{2,3}[）\)]?[-]?)?([2-9][0-9]{6,7})+(\-[0-9]{1,4})?)$" data-validate-regexp-message="电话号码格式不正确" maxlength="50" required>
						  </div>
					  </div>

					  <div class="form-group">
					  	<div class="text-red text-warnning">请填写长期有效的信息，以便于货物收取安全！</div>
					  </div>

					  <div class="form-group-rci">
						<button type="submit" class="btn btn-primary btn-primary-rci">提交审核</button>
					  </div>
		      	</div>
			  </div>
		  </div>
	    <!-- </fieldset> -->
	</form>
</div>
<!-- modal -->
<div class="modal fade" id="example_img_modal" tabindex="-1" role="dialog">
  <div class="panel panel-default modal-dialog modal-lg">
    <div class="panel-heading">
      <div class="clearfix">
      	<div class="pull-left">示例</div>
        <div class="pull-right">
          <i class="glyphicon glyphicon-remove" data-dismiss="modal"></i>
        </div>
      </div>
    </div>
    <div class="panel-body text-center">
      <div class="big-img-show example-img-show"><div class="show-position"><img src="" alt="" ></div></div>
    </div>
  </div>
</div>


<div class="modal fade" id="detail_img_modal" tabindex="-1" role="dialog">
	<div class="panel panel-default modal-dialog modal-lg">
	  <div class="panel-heading">
		<div class="clearfix">
			<div class="pull-left">查看大图</div>
		  <div class="pull-right">
			<i class="glyphicon glyphicon-remove" data-dismiss="modal"></i>
		  </div>
		</div>
	  </div>
	  <div class="panel-body text-center">
		<div class="big-img-show example-img-show"><div class="show-position"><img src="" alt="" ></div></div>
	  </div>
	</div>
  </div>



<script>
	var ismainland = '<{$shop_info.is_mainland}>';
	var flag = false;
	if(ismainland != '') {
		formNat(ismainland);
	}
	$('#form-select-nat').on('change',function(){
	  formNat($('#form-select-nat').val());
	});
	function formNat(natval){
	  if(natval == '1'){
	      $('#form-identity').show();
	      $('#form-passport').hide();
	  }else{
	    $('#form-identity').hide();
	    $('#form-passport').show();
	  }
	}

	//查看示例
	$('.img-example').on('click', function(e) {
		e.preventDefault();
		var that = $(this);
		$('.show-position').empty();
		$('#example_img_modal').modal('show').on('shown.bs.modal', function() {
			$(this).find('.show-position').html('<img src="'+ that.attr('href') +'">');
		});
	});

	$('.remind-content > .glyphicon').on('mouseover', function() {
		$(this).siblings('span').show();
	}).on('mouseout', function() {
		$(this).siblings('span').hide();
	});

	function ajaxSubmit (e) {
		e.preventDefault();
		validIllege()
		
		if(flag) { return false; }

		var form = e.target;
		var licenseIsUpload = $('#license-img-form').find('.image-box').length > 0

		if(!licenseIsUpload) {
			$('#messagebox').message('请上传营业执照副本扫描件！', 'success');
			return false;
		}
		$.post(form.action, $(form).serialize(), function(rs) {
			if(rs.error) {
				$('#messagebox').message(rs.message);
				return;
			}
			if(rs.redirect) {
				flag = false
				location.href = rs.redirect;
			}
		});
	}


	// 限制用户输入空格特殊字符
    function validIllege() {
      $.each($('input'),function(k, el) {
        var regEn
		var val = $(this).val()
		if(!val) return
		if($(el).attr('type') == 'hidden' || $(el).attr('type') == 'checkbox') return
		
		
		if(/(^\s+)|(\s+$)|\s+/g.test(val)) {
		  flag = true
		  $(el).focus()
          setTimeout(() => {
            $(this).parents('.form-group').removeClass('has-success').addClass('has-feedback').addClass('has-error')
            $(this).parents('.form-group').find('.form-control-feedback ')
              .removeClass('icon-checkmark-a')
              .addClass('icon-alert')
          }, 0);
          $('#messagebox').message('您输入了空格，请重新输入', 'error');
          return false;
        }
        regEn = /^[\u4e00-\u9fa5a-zA-Z0-9]+$/
		if(regEn.test(val) == false) {
			flag = true
			$(el).focus()
			setTimeout(() => {
			$(this).parents('.form-group').removeClass('has-success').addClass('has-feedback').addClass('has-error')
			$(this).parents('.form-group').find('.form-control-feedback ')
				.removeClass('icon-checkmark-a')
				.addClass('icon-alert')
			
			}, 0);
			$('#messagebox').message('您输入了非法字符，请重新输入', 'error');
			return false;
		}else {
			flag = false
		}

		
        
      })
    }



	var selectCats = [];
	$('#shop_cat').val();
	$(function(){
		if($('#shop_type').val() == 'store') {
			$('#shop_cat').val();
			var selectCatIds = $('#shop_cat').val();
			$(selectCatIds).each(function(i) {
			  var catValue = selectCatIds[i];
			  if($.inArray(catValue, selectCats) == -1 && catValue != '') {
			    selectCats.push(catValue);
			  }
			});
			loadSelectCat(selectCats);
		}
	});

	$('.wrapper').scrollspy({
	target: '.sidebar'
	});

	$('#shop_type').on('change',function(){
	  $('.select-cat').hide();
	  if($(this).val() == "cat" || $(this).val() == "store"){
	    if($(this).val() == "store"){
	      $('#shop_cat').attr('multiple','multiple');
	      $('.select-cat').show();
	    }else{
	      $('#shop_cat').removeAttr('multiple');
	    }
	    $('.brand-type').hide();
	  }else{
	      $('#shop_cat').removeAttr('multiple');
	    $('.brand-type').show();
	  }
	  $('.shop-name-suffix').html($(this).find('option:selected').attr('data-suffix'));

	}).trigger('change');

	//用于记录选中的经营类目
	$('#shop_cat').on('change',function(){
	  var shoptypeval = $('#shop_type').val();
	  //记录选中的经营类目
	  if(shoptypeval == 'store') {
	    $(this).find('option:selected').each(function() {
	      var catValue = $(this).val();
	      if($.inArray(catValue, selectCats) == -1 && catValue != '') {
	        selectCats.push(catValue);
	      }
	    });
	    loadSelectCat(selectCats);
	  }
	  var url = "<{url action=topshop_ctl_enterapply@ajaxCatBrand}>";
	  if($(this).val() && shoptypeval != "cat" && shoptypeval != "store" ) {
	    $.post(url,'cat_id='+$(this).val(),function(rs){
	      var optionstring = "";
	      for (var j = 0; j < rs.length; j++) {
	        optionstring += '<option value="' + rs[j].brand_id + '"';
	        if(rs[j].brand_id == '<{$shop.shop_brand}>') {
	          optionstring += ' selected';
	        }
	        optionstring += '>' + rs[j].brand_name + '</option>';
	      }
	      $("#shop_brand").html("<option value=''>请选择...</option> "+optionstring).trigger('change');

	    });
	  }
	}).trigger('change');

	//删除选中的经营类目
	$('.select-cat').on('click', '.del', function() {
	  var parent = $(this).parent();
	  var catIndex = parent.attr('data-value');
	  parent.remove();
	  selectCats.splice($.inArray(catIndex,selectCats), 1);
	  loadSelectCat(selectCats);
	});

	//选中并加载店铺经营类目文本提示
	function loadSelectCat(arr) {
	  var selectCatHtml = '';
	  $('#shop_cat').val(arr);
	  $(arr).each(function(index) {
	    var selOption = $('#shop_cat option[value="'+arr[index]+'"]');
	    selectCatHtml += '<span data-value="'+arr[index]+'">'+ selOption.text() +'<i class="del">x</i></span>';
	  });
	  $('.select-cat-item').html(selectCatHtml);
	}

	
	// 多图上传逻辑
	$(document.body).on('click','.rci-action-upload',function () {
		var input_file = $(this).parents('.choose-image').find('.mul-file-input')
		input_file.click()
		
	}).on('change','.mul-file-input',function(e) {
			var files = this.files;
			console.log(files,'files')
			var input_file = $(this)
			var url = $(this).data('remote');
			var size = $(this).data('size')
			var formData = new FormData();
			var container = $(this).parents('.choose-image').find('.image-wrapper')

			var limit = $(this).data('limit')

			console.log(files,'files')
			var multiple = this.multiple;

			if(!files || !Array.prototype.slice.call(files).every(function (file, i) {
	            if(file.size > size) {
					$('#messagebox').message('抱歉，上传图片 "' + file.name + '" 须小于' + size / 1024 + 'kB!', 'error');
	                input_file.val('');
	                return false;
				}
				console.log(file,'file')
	            if(multiple) {
	                formData.append('upload_files' + '[]', file);
	            }
	            else {
	                formData.append('upload_files', file);
	            }
	            return true;
			})) return false;
			$.ajax({
	            url: url,
	            type: 'POST',
	            data: formData,
	            cache: false,
	            contentType: false,
	            processData: false,
	            success: function (rs) {
	                try {
	                    rs = JSON.parse(rs);
					}
					catch (e) {}
					
					var length = container.find('.image-box').length
					var inputName = container.siblings('input').attr('name')
					var html

					if(rs.success && rs.data) {

						$.each(rs.data, function (k, data) {
							var nexLen = length + k
							html = '<span class="image-box" data-index="'+ nexLen +'"><img src="' + data.url +'"/><input type="hidden" name="'+inputName+'['+ nexLen +']" value="'+ data.url +'">'
							html += '<div class="image-mask"><a  href="'+data.url+'" class="img-detail_btn"><i class="fa fa-search-plus show-img"></i></a><i class="fa fa-trash del-img_btn" ></i></div>'
							html+='</span>'

							$(html).insertBefore(container.find('.rci-action-upload'))
						})
						

						mulActions()
					}else if(rs.message) {
						$('#messagebox').message(rs.message, 'error');
					}
					input_file.val('');
	            },
	            error: function () {
	                alert('上传出错，请重试');
	            }
	        });
		})


	function mulActions(param) { 
		$('.img-detail_btn').on('click', function(e) {
			e.preventDefault();
			var that = $(this);
			$('.show-position').empty();
			$('#detail_img_modal').modal('show').on('shown.bs.modal', function() {
				$(this).find('.show-position').html('<img src="'+ that.attr('href') +'">');
			});
		});

		$(document.body).on('click','.del-img_btn',function(e) {
			e.preventDefault();
			var wrapper = $(this).parents('.image-wrapper')
			var imgBox = $(this).parents('.image-box')
			var curIndex = imgBox.data('index')

			$(this).parents('.image-box').remove()

			
			var otherChild = wrapper.find('.image-box')
			
			$.each($(otherChild), function (k, el) {
				var inputName = $(el).parents('.image-wrapper').siblings('input').attr('name')
				$(el).find('input').attr("name",inputName + "["+ k +"]")
				$(el).attr("data-index",k)
			})
		})
	}

	mulActions()

	
</script>
